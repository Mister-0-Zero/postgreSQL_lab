# –ó–µ–ª–µ–Ω–æ–≥—Ä–∞–¥—Å–∫–æ–µ –∫–ª–∞–¥–±–∏—â–µ ‚Äî –ø—Ä–æ–µ–∫—Ç –ø–æ –∫—É—Ä—Å—É "–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –≤ —Ä–∞–º–∫–∞—Ö —É—á–µ–±–Ω–æ–π –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã **"–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"**. –û–Ω –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É –ª–æ–≥–∏—á–µ—Å–∫–æ–π –º–æ–¥–µ–ª–∏ –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–π –¥–ª—è —É—á–µ—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–ª–∞–¥–±–∏—â–∞—Ö, –º–æ–≥–∏–ª–∞—Ö, —É–º–µ—Ä—à–∏—Ö, —É—Å–ª—É–≥–∞—Ö –∏ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –Ω–∏–º–∏ –æ–±—ä–µ–∫—Ç–∞—Ö.

## üìå –û–ø–∏—Å–∞–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, —Å–≤—è–∑–∞–Ω–Ω–æ–π —Å —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–º –∫–ª–∞–¥–±–∏—â–µ–º –ó–µ–ª–µ–Ω–æ–≥—Ä–∞–¥–∞. –í –ø—Ä–æ–µ–∫—Ç–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö, –≤–∫–ª—é—á–∞—é—â–∞—è –≤ —Å–µ–±—è –¥–∞–Ω–Ω—ã–µ –æ —É—á–∞—Å—Ç–∫–∞—Ö, –º–æ–≥–∏–ª–∞—Ö, —É–º–µ—Ä—à–∏—Ö, —Ä–∏—Ç—É–∞–ª—å–Ω—ã—Ö –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞—Ö, —É—Å–ª—É–≥–∞—Ö –∏ –∑–∞–∫–∞–∑–∞—Ö.

## üõ†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- PostgreSQL
- PL/pgSQL (–¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–∞)
- SQL 

## üóÉÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö —Ç–∞–±–ª–∏—Ü:

| –¢–∞–±–ª–∏—Ü–∞          | –û–ø–∏—Å–∞–Ω–∏–µ                                  |
|------------------|-------------------------------------------|
| `plots`          | –£—á–∞—Å—Ç–∫–∏ –∫–ª–∞–¥–±–∏—â–∞ (–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ, –°–µ–≤–µ—Ä–Ω–æ–µ)  |
| `graves`         | –ú–æ–≥–∏–ª—ã —Å –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏     |
| `funeralagencies`| –†–∏—Ç—É–∞–ª—å–Ω—ã–µ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞                      |
| `deceased`       | –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É–º–µ—Ä—à–∏—Ö                     |
| `services`       | –£—Å–ª—É–≥–∏, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º—ã–µ –Ω–∞ –∫–ª–∞–¥–±–∏—â–µ       |
| `orders`         | –ó–∞–∫–∞–∑—ã –Ω–∞ —É—Å–ª—É–≥–∏                          |

```mermaid
erDiagram
    plots ||--o{ graves : "1:N"
    funeralagencies ||--o{ services : "1:N"
    funeralagencies ||--o{ deceased : "1:N"
    graves ||--o| deceased : "1:1 (UNIQUE)"
    deceased }o--|| services : "N:1"
    services ||--o{ orders : "1:N"
    graves ||--o{ orders : "1:N"
```

## ‚úÖ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è

- –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–¥–µ—Ä–∂–∞—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è `NOT NULL`, `CHECK`, `UNIQUE` –∏ –≤–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏ (`FOREIGN KEY`)
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ —Å –ø–æ–º–æ—â—å—é —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π
- –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –Ω–∞ –¥–æ–ø—É—Å—Ç–∏–º—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–∫–∏ –¥–∞—Ç: –¥–∞—Ç–∞ —Å–º–µ—Ä—Ç–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è

## üîÑ –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞

### –¢—Ä–∏–≥–≥–µ—Ä—ã

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Ç—Ä–∏–≥–≥–µ—Ä `trg_set_grave_occupied`, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å `is_occupied = true` —É –º–æ–≥–∏–ª—ã –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —É–º–µ—Ä—à–µ–≥–æ (`deceased`), –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–≥–æ –∫ –Ω–µ–π.

```sql
create trigger trg_set_grave_occupied
after insert on deceased	
for each row
when (new.grave_id is not null)
execute procedure set_grave_occupied();
```
–¢–∞–∫–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Ç—Ä–∏–≥–≥–µ—Ä `add_burial_order`, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü—É `orders` –ø—Ä–∏ –Ω–æ–≤–æ–º –ø–æ–≥–∏–±—à–µ–º, –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —É—Å–ª—É–≥–∞ `–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –ø–æ—Ö–æ—Ä–æ–Ω`

```sql
CREATE OR REPLACE FUNCTION add_burial_order()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO orders (service_id, grave_id, order_date, status)
  VALUES (NEW.burial_service_id, NEW.grave_id, NEW.date_dead, '–≤—ã–ø–æ–ª–Ω–µ–Ω–æ');

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_add_burial_order
AFTER INSERT ON deceased
FOR EACH ROW
EXECUTE FUNCTION add_burial_order();
```
–¢–∞–∫–∂–µ —Å–æ–∑–¥–∞–Ω—ã –∏–Ω–¥–µ–∫—Å—ã (—Ñ–∞–π–ª add_index.sql) –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã (procedure.sql)

### üìã –ü—Ä–æ—Ü–µ–¥—É—Ä—ã –∏ –∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

1. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏

```sql
-- –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ –ø–æ –º–æ–≥–∏–ª–µ
CALL delete_orders_by_grave(123);

-- –ü—Ä–∏–º–µ—Ä –≤—ã–∑–æ–≤–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π:
DO $$
BEGIN
  CALL delete_orders_by_grave(123);
  RAISE NOTICE '–£–¥–∞–ª–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤: %', (SELECT COUNT(*) FROM orders WHERE grave_id = 123);
END $$;
```

2. –ê–Ω–∞–ª–∏—Ç–∏–∫–∞

```sql
-- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —É—Å–ª—É–≥–∞–º
CALL generate_service_stats();

-- –ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
SELECT * FROM service_stats ORDER BY order_count DESC;
```

3. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ

```sql
-- –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ë–î (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é!)
CALL clear_all_data();

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—á–∏—Å—Ç–∫–∏
SELECT COUNT(*) FROM deceased;  -- –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å 0
```

4. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤

```sql
-- –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –Ω–∞ –∑–∞—Ö–æ—Ä–æ–Ω–µ–Ω–∏–µ
CALL create_burial_order(456);

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
SELECT * FROM orders WHERE grave_id = (SELECT grave_id FROM deceased WHERE id = 456);
```
5. –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –º–æ–≥–∏–ª—ã

```sql
CALL mark_grave_as_available(15);
```

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:

- –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è (–≤ pgAdmin4):

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª create_DB.sql
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª create_tables_and_triggers.sql
3. –î–æ–±–∞–≤—å—Ç–µ –∏–Ω–¥–µ–∫—Å—ã –≤ –ø—Ä–æ–µ–∫—Ç –∑–∞–ø—É—Å—Ç–∏–≤: add_index.sql
4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª fill_DB.sql
5. –î–∞–ª–µ–µ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∑–∞–ø—É—Å—Ç–∏–≤ procedure.sql

- –ß–µ—Ä–µ–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª:

1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î:
psql -f create_DB.sql

2. –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:
psql -f create_tables_and_triggers.sql

3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:
psql -f add_index.sql

4. –ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏:
psql -f fill_DB.sql

5. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã:
psql -f procedure.sql

- –° —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞ –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞, –ø—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ —Ñ–∞–π–ª–µ:
query_example.sql

# –ê–≤—Ç–æ—Ä:

- –õ—è–¥–∫–æ–≤ –ê–ª–µ–∫—Å–µ–π
- GitHub: @mister-0-zero

# –î–æ–ø.

## üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü

| –¢–∞–±–ª–∏—Ü–∞             | –ü–æ–ª—è                                                                                                                   |
|--------------------------------------------------------------------------------------------------------------------------------------------- |
| **plots**           | `id (PK)`, `name`, `latitude`, `longitude`                                                                             |
| **graves**          | `id (PK)`, `plot_id (FK)`, `is_occupied`, `description`                                                                |
| **funeralagencies** | `id (PK)`, `name`, `phone`, `address`                                                                                  |
| **deceased**        | `id (PK)`, `full_name`, `date_birthday`,`date_dead`,`cause_of_death`,`grave_id (FK, UNIQUE)`, `funeralagency_id(FK)`|                    | `service_id (FK)`                                                                                                      |
| **services**        | `id (PK)`, `funeralagency_id (FK)` `name`, `price`                                                                     |
| **orders**          | `id (PK)`, `service_id (FK)`, `grave_id (FK)`, `order_date`,`status`                                                   |

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è

| –¢–∞–±–ª–∏—Ü–∞             | –ü–æ–ª–µ               | –¢–∏–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è         | –û–ø–∏—Å–∞–Ω–∏–µ                                                              |
| ------------------- | ------------------ | ----------------------- | --------------------------------------------------------------------- |
| **plots**           | `name`             | `NOT NULL`              | –ò–º—è —É—á–∞—Å—Ç–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ                                               |
|                     | `latitude`         | `NOT NULL`, `CHECK`     | –î–∏–∞–ø–∞–∑–æ–Ω: –æ—Ç -90 –¥–æ 90 –∏ –Ω–µ –ø—É—Å—Ç–æ–µ                                    |
|                     | `longitude`        | `NOT NULL`, `CHECK`     | –î–∏–∞–ø–∞–∑–æ–Ω: –æ—Ç -180 –¥–æ 180 –∏ –Ω–µ –ø—É—Å—Ç–æ–µ                                  |
| **graves**          | `plot_id`          | `FOREIGN KEY`           | –°—Å—ã–ª–∫–∞ –Ω–∞ `plots(id)`                                                 |
|                     | `is_occupied`      | `DEFAULT`               | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `false`                                        |
| **funeralagencies** | `name`             | `UNIQUE`, `NOT NULL`    | –ù–∞–∑–≤–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∏ –Ω–µ –ø—É—Å—Ç—ã–º                 |
|                     | `phone`            | `CHECK`                 | –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ: `^\+?[0-9]{5,12}$`                              |
| **deceased**        | `full_name`        | `NOT NULL`              | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ                                                     |
|                     | `date_dead`        | `CHECK`                 | –î–∞—Ç–∞ —Å–º–µ—Ä—Ç–∏ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ—Å–ª–µ –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è                           |
|                     | `grave_id`         | `UNIQUE`, `FOREIGN KEY` | –°—Å—ã–ª–∫–∞ –Ω–∞ `graves(id)`, —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å ‚Äî –æ–¥–Ω–∞ –º–æ–≥–∏–ª–∞ –Ω–∞ –æ–¥–Ω–æ–≥–æ —É–º–µ—Ä—à–µ–≥–æ |
|                     | `funeralagency_id` | `FOREIGN KEY`           | –°—Å—ã–ª–∫–∞ –Ω–∞ `funeralagencies(id)`                                       |
|                     | `service_id`       | `FOREIGN KEY`           | –°—Å—ã–ª–∫–∞ –Ω–∞ `service(id)`                                               |
| **services**        | `name`             | `NOT NULL`              | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏                                          |
|                     | `funeralagency_id` | `FOREIGN KEY`           | –°—Å—ã–ª–∫–∞ –Ω–∞ `funeralagencies(id)`                                       |
|                     | `price`            | `NOT NULL`, `CHECK`     | –¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π                                        |
| **orders**          | `service_id`       | `FOREIGN KEY`           | –°—Å—ã–ª–∫–∞ –Ω–∞ `services(id)`                                              |
|                     | `grave_id`         | `FOREIGN KEY`           | –°—Å—ã–ª–∫–∞ –Ω–∞ `graves(id)`                                                |
|                     | `order_date`       | `DEFAULT`               | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: `current_date`                                          |
|                     | `status`           | `NOT NULL`              | –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω                                              |


–ü—Ä–æ–µ–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –≤ —É—á–µ–±–Ω—ã—Ö —Ü–µ–ª—è—Ö